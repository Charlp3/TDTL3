<!DOCTYPE html>

<html lang="fr"><head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Contacts ENEO ‚Äî v4.0 (test fix6)</title>
<meta content="#5b6169" name="theme-color"/>
<style>
:root{ --bg:#6b7178; --card:#8c9299; --text:#0b1220; --muted:#212733; --border:#4e5560; --accent:#2563eb;
  --zebra1:#9aa0a7; --zebra2:#8c9299; --good:#8ee59e; --bad:#f28b82; --warn:#fbc02d; }
*{box-sizing:border-box} html,body{margin:0;padding:0;height:100%}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial;min-height:100%}
.wrapper{display:flex;flex-direction:column;min-height:100vh}
.container{max-width:980px;margin:0 auto;padding:8px;width:100%}

/* Sticky top area */
.topbar{position:sticky;top:0;z-index:50;background:var(--bg);box-shadow:0 14px 30px rgba(0,0,0,.18)}
.title{display:flex;gap:10px;align-items:center;margin:0 0 6px;font-size:18px;font-weight:800}
.ver{font-size:12px;color:#fff;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:2px 8px;background:rgba(0,0,0,.25);font-weight:700}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px;margin:8px 0}
.controls{display:flex;gap:4px;flex-wrap:nowrap;align-items:center}
.controls .icon{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;
  box-shadow: 0 6px 12px rgba(0,0,0,.35), inset 0 -2px 3px rgba(255,255,255,.45)}
button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:6px 8px;font-weight:700;cursor:pointer;
  font-size:15px;line-height:1;touch-action:manipulation;
  box-shadow: 0 6px 12px rgba(0,0,0,.35), inset 0 -2px 3px rgba(255,255,255,.45)}
button.secondary{background:#fff;color:#000;border:1px solid var(--border)}
input[type="text"],input[type="email"],input[type="tel"],input[type="number"],input[type="date"],input[type="file"]{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 8px;font-size:14px}

/* DATE narrow (label removed) */
#sessionDate{width:100px;height:32px}
@media (max-width:430px){ #sessionDate{width:96px} }

/* Tool row: eye | date | icon group */
.toolrow{display:grid;grid-template-columns:auto auto 1fr;align-items:center;gap:6px}
.rightIcons{display:flex;gap:4px;justify-content:flex-end;flex-wrap:nowrap}

/* File row: + | file | arrow */
.fileRow{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
#importCsv{max-width:520px;justify-self:center}
@media (max-width:430px){ #importCsv{max-width:62vw} }

.table-wrap{flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:separate;border-spacing:0 4px;table-layout:auto}
thead th{font-size:11px;color:var(--muted);border-bottom:1px dashed var(--border);text-transform:uppercase;position:sticky;top:0;background:var(--card);z-index:1}
tbody tr{background:var(--zebra2);border:1px solid var(--border)}
tbody tr:nth-child(odd){background:var(--zebra1)}
tbody td{padding:6px 8px;vertical-align:middle;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
/* Bold name and firstname */
td.name, td.pre{font-weight:800}
tr.state-green{background:var(--good)!important} tr.state-red{background:var(--bad)!important} tr.state-yellow{background:var(--warn)!important}
.amount input{width:6ch;text-align:right}
.col-pres{width:46px} .col-amt{width:64px}
.col-name{width:auto;max-width:22ch} .col-pre{width:auto;max-width:16ch}
.col-gsm{width:110px} .col-mail{width:auto;min-width:28ch}
.pres input[type="checkbox"]{width:20px;height:20px}
.actions{white-space:nowrap;width:92px; overflow:visible !important; position:sticky; right:0; background:var(--card);}
.actions button{padding:6px 8px;font-size:16px}
.actions{display:flex;gap:6px;justify-content:center;align-items:center}

/* Stats above table: grey background, white text, small */
.stats{color:#fff;background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:10px;padding:6px 8px;margin:6px 0;
       display:flex;flex-wrap:wrap;gap:12px;font-size:12px}
.hidden{display:none!important}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111827;color:#e5e7eb;padding:8px 12px;border-radius:10px;border:1px solid #374151;display:none}
.debug{font:12px ui-monospace,monospace;background:#111827;color:#f3f4f6;border:1px solid #374151;border-radius:10px;padding:8px;white-space:pre-wrap}
@media (max-width: 430px){ .col-name{max-width:20ch} .col-pre{max-width:14ch} .col-mail{min-width:30ch} }
@media print{body{background:#fff!important;color:#000!important}.card{box-shadow:none!important;border:none!important;background:#fff!important}
table,thead,tbody,tr,td,th{page-break-inside:avoid!important}tr{page-break-after:auto}}

/* toolbar layout patch: spacer to push right group */
.toolbar-spacer-flex { flex: 1 1 auto; }
#btnResetListFinal {
  background-color: #dc3545 !important;
  border-color: #dc3545 !important;
  color: #fff !important;
}
#btnResetListFinal:hover {
  background-color: #bb2d3b !important;
  border-color: #b02a37 !important;
}


/* === FIXED ALL: header date + hide toolbar date === */
.app-date{ margin-left:8px; font-size:14px; font-weight:700; color:#fff; white-space:nowrap; }
#sessionDate{ position:absolute !important; left:-9999px !important; width:0 !important; height:0 !important; opacity:0 !important; pointer-events:none !important; }
/* Reset red danger */
#btnReset{ background-color:#dc3545 !important; border-color:#dc3545 !important; color:#fff !important; }
#btnReset:hover{ background-color:#bb2d3b !important; border-color:#b02a37 !important; }
/* Spacer for right group */
.toolbar-spacer-flex{ flex:1 1 auto; }

</style>
<style id="eneo-ui-v48">
:root{
  --amber:#facc15;
  --amber-ink:#92400e;
  --beige:#f5f0e6;
  --beige-border:#e7dfd0;
}
/* Title color */
#appName{ color: var(--amber); font-weight: 900; letter-spacing:.2px; }
/* Reset button (#resetRoster) icon-only look */
button#resetRoster{
  background:#fff !important;
  color:var(--amber-ink) !important;
  border:2px solid var(--amber) !important;
  border-radius:12px !important;
  padding:8px !important;
  line-height:1 !important;
  font-size:18px !important;
}
/* Spacer */
.btn-spacer{ display:inline-block; width:120px; height:1px; }
/* Add button (#toggleAddForm) beige look */
button#toggleAddForm{
  background:var(--beige) !important;
  border:1px solid var(--beige-border) !important;
  color:#111 !important;
  border-radius:12px !important;
  padding:10px 14px !important;
  font-weight:900 !important;
  font-size:20px !important;
}
</style>
<style id="eneo-ui-v49b">
button#resetRoster {
  margin-right: 160px !important;
  margin-top: 8px !important;
  margin-bottom: 8px !important;
}
</style>
</head><body>
<div class="wrapper">
<div class="topbar">
<div class="container">
<h1 class="title"><span id="appName">TDTL3</span> ‚Äî <span class="ver">v4.9c</span><span class="app-date" id="dateHeader"></span></h1>
<div class="card">
<div class="toolrow">
<button class="secondary icon" id="toggleGsmMail" title="Montrer/Cacher GSM+Mail">üëÅÔ∏è</button>
<div class="controls"><input aria-label="Date" id="sessionDate" type="date"/></div>
<div class="rightIcons">
<button class="secondary icon" id="exportPDF" title="Imprimer/PDF">üñ®Ô∏è</button>
<button class="secondary icon" id="resetFields" title="R√©initialiser Pr√©sence/‚Ç¨">üßπ</button>
<button class="secondary icon" id="resetRoster" title="R√©initialiser la liste (CSV int√©gr√©)">‚ö†Ô∏è</button><span class="btn-spacer"></span>
<button class="secondary icon" id="saveRoster" title="Sauver la liste">üíæ</button>
<button class="secondary icon" id="copyTable" title="Copier Pr√©s/‚Ç¨/Nom/Pr√©nom">üìã</button>
</div>
</div>
</div>
<div class="card fileRow">
<button aria-label="Ajouter" class="icon" id="toggleAddForm" title="Ajouter">Ôºã</button>
<input accept=".csv" id="importCsv" title="Choisir un CSV" type="file"/>
<button class="secondary icon" id="importCsvReplace" title="Importer CSV (Remplacer)">‚¨áÔ∏è</button>
</div>
<div class="card controls" id="addForm" style="display:none;margin-top:6px;gap:6px">
<input id="addNom" placeholder="Nom"/><input id="addPrenom" placeholder="Pr√©nom"/>
<input id="addGsm" placeholder="GSM (047...)"/><input id="addMail" placeholder="Mail"/>
<button class="icon" id="addMember" title="Ajouter">‚úÖ</button>
</div>
<!-- Stats above list -->
<div class="stats">
<div>Pr√©sents: <span id="countPresence">0</span></div>
<div>Pr√©sents gratuits: <span id="countFree">0</span></div>
<div>Pr√©sents 0‚Ç¨: <span id="countZero">0</span></div>
<div>Pr√©sents payants: <span id="countPaid">0</span></div>
<div>Total ‚Ç¨: <span id="sumPaid">0,0</span></div>
<div>Inscrits: <span id="inscritsCounter">0</span></div>
</div>
</div>
</div>
<div class="container table-wrap">
<div class="card table-wrap">
<table id="tbl"><thead>
<tr><th class="col-pres">Pr√©s.</th><th class="col-amt">‚Ç¨</th><th class="col-name">Nom</th><th class="col-pre">Pr√©nom</th><th class="col-gsm">GSM</th><th class="col-mail">Mail</th><th>Actions</th></tr>
</thead><tbody id="tbody"></tbody></table>
</div>
<div class="card" id="diagCard">
<div class="debug" id="diag">Initialisation‚Ä¶</div>
</div>
</div>
</div><!-- wrapper -->
<div class="toast" id="toast">OK</div>
<script id="seed" type="application/json">[{"nom": "ALLACKER", "prenom": "Paul", "gsm": "477621626", "mail": "paul.allacker@skynet.be"}, {"nom": "BOSSCHAERT", "prenom": "Fran√ßoise", "gsm": "474717828", "mail": "francoise.bosschaert@gmail.com"}, {"nom": "CHARLIER", "prenom": "Pierre", "gsm": "475677680", "mail": "charlier.pierre@skynet.be"}, {"nom": "CHIMKOVITCH", "prenom": "Sophie", "gsm": "474979997", "mail": "sophie.chimkovitch@gmail.om"}, {"nom": "DALLEUR", "prenom": "Jean-Paul", "gsm": "474877837", "mail": "dalleurj@gmail.com"}, {"nom": "DECONINCK", "prenom": "Jean-Pierre", "gsm": "476728383", "mail": "sra@lesanemones.be"}, {"nom": "DEGUENT", "prenom": "Marianne", "gsm": "474811346", "mail": "mdeguent7@gmail.com"}, {"nom": "DENIS", "prenom": "Pierrette", "gsm": "472720227", "mail": "Pierrette_denis@outlook.be"}, {"nom": "DEPIREUX", "prenom": "Dominique", "gsm": "479949630", "mail": "gekerado@gmail.com"}, {"nom": "DIEU", "prenom": "Bernard", "gsm": "476294840", "mail": "planetedit0@gmail.com"}, {"nom": "DOLVELDE", "prenom": "Dick", "gsm": "478780555", "mail": "dick.dolvelde@gmail.com"}, {"nom": "DONNAY", "prenom": "Jacques", "gsm": "476634435", "mail": "jack.donnay30@gmai.com"}, {"nom": "DUBOIS", "prenom": "Claude", "gsm": "477712083", "mail": "dubois.claude@hotmail.com"}, {"nom": "GILLET", "prenom": "Christiane", "gsm": "474693200", "mail": "christiane.gillet@hotmail.com"}, {"nom": "HEYTERS", "prenom": "Eric", "gsm": "475826923", "mail": "eric.heyters@gmail.com"}, {"nom": "LEGLISE", "prenom": "Stephan", "gsm": "476340062", "mail": "unpierreux@yahoo.fr"}, {"nom": "LEVEAU", "prenom": "Jos√©", "gsm": "479321442", "mail": "jcleveau@yahoo.fr"}, {"nom": "LEVELING", "prenom": "Josette", "gsm": "475386560", "mail": "josette.paulus@gmail.com"}, {"nom": "MAGERUS", "prenom": "Michel", "gsm": "476892128", "mail": "michelmagerus@gmail.com"}, {"nom": "MALDAGUE", "prenom": "Olivier", "gsm": "478371701", "mail": "olivier.maldague@gmail.com"}, {"nom": "PAPENS", "prenom": "Dominique", "gsm": "475993125", "mail": "dompapens@yahoo.fr"}, {"nom": "PAULUS", "prenom": "Christian", "gsm": "475284580", "mail": "chpaulus@gmail.com"}, {"nom": "PERROTIN", "prenom": "Herv√©", "gsm": "472212131", "mail": "hymperrotin@gmail.com"}, {"nom": "PUTMANS", "prenom": "Yves", "gsm": "478669111", "mail": "yves.putmans@yahoo.fr"}, {"nom": "RION", "prenom": "Marc-Antoine", "gsm": "475388934", "mail": "marcantoinerion1965@gmail.com"}, {"nom": "SCHILDERMANS", "prenom": "Alain", "gsm": "475606443", "mail": "alain.schildermans@gmail.com"}, {"nom": "VAN PELT", "prenom": "V√©ronique", "gsm": "477456193", "mail": "veronique.vanpelt@icloud.com"}, {"nom": "VANCAPPELLEN", "prenom": "Arlette", "gsm": "477359066", "mail": "arlettevancap@hotmail.com"}, {"nom": "VANDEN BRUGGE", "prenom": "Andr√©e", "gsm": "475381914", "mail": "audrey.vdb.bruens@gmail.com"}, {"nom": "VANDENBROUCKE", "prenom": "Jacques", "gsm": "477261193", "mail": "javanwa41@gmail.com"}, {"nom": "VIGNERON", "prenom": "Jean-Marie", "gsm": "474921000", "mail": "jemavig@live.be"}, {"nom": "WERY", "prenom": "Jean-Luc", "gsm": "478293294", "mail": "weryjl@hotmail.fr"}, {"nom": "WINDAL", "prenom": "Beno√Æt", "gsm": "475941124", "mail": "michele.et.benoit.windal@gmail.com"}]</script>
<script>
(function(){
  const rosterKey='contacts-eneo:roster-v4.0-test-fix6';
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const toast=(m)=>{const t=$('#toast');t.textContent=m||'OK';t.style.display='block';setTimeout(()=>t.style.display='none',1200)};
  const diag=(msg)=>{ const d=$('#diag'); d.textContent = (d.textContent? d.textContent+"\n":"")+msg; };
  window.onerror = function(msg, src, line, col){ diag("ERREUR JS ‚Üí "+msg + " @ " + line + ":" + col); };

  function getSeed(){ try{ return JSON.parse(document.getElementById('seed').textContent || "[]"); } catch(e){ return []; } }
  const CSV_ROSTER = getSeed();

  let colsHidden = true;
  function setColsVisibility(hide){
    colsHidden = hide;
    document.querySelectorAll('th.col-gsm,th.col-mail,td.col-gsm,td.col-mail').forEach(td=>td.classList.toggle('hidden',hide));
  }

  function normGSM(s){
    if(!s) return '';
    var t=String(s).trim().replace(/[^0-9+]/g,'');
    if(t.indexOf('+324')===0) t='0'+t.slice(3);
    if(t.indexOf('0')!==0) t='0'+t.replace(/^0+/,'');
    if(t.indexOf('04')===0 && t.indexOf('047')!==0) t='047'+t.slice(3);
    t=t.replace(/\D/g,''); if(t.length>10) t=t.slice(0,10);
    return t;
  }

  function loadRosterRaw(){ try{ var r=JSON.parse(localStorage.getItem(rosterKey)||'[]'); return Array.isArray(r)?r:[]; } catch(e){ return []; } }
  function loadRoster(){
    var r = loadRosterRaw();
    if(!r || r.length===0){ r = CSV_ROSTER.slice(); try{ localStorage.setItem(rosterKey, JSON.stringify(r)); }catch(e){} diag("Liste restaur√©e √† partir du CSV int√©gr√©"); }
    return r.map(m=>({ nom:(m.nom||''), prenom:(m.prenom||''), gsm:normGSM(m.gsm||''), mail:(m.mail||'') }));
  }
  function saveRoster(r){ r.forEach(m=>{ m.gsm=normGSM(m.gsm||''); }); try{ localStorage.setItem(rosterKey, JSON.stringify(r)); }catch(e){} updateCounts(); }

  function makeRow(m){
    var tr=document.createElement('tr');
    tr.innerHTML='<td class="pres"><input type="checkbox"></td>' +
                 '<td class="amount"><input type="number" step="0.5" min="0" placeholder="0,0"></td>' +
                 '<td class="name col-name"></td><td class="pre col-pre"></td>' +
                 '<td class="gsm col-gsm"></td><td class="mail col-mail"></td>' +
                 '<td class="actions"><button class="secondary editRow" title="Modifier">‚úèÔ∏è</button><button class="secondary deleteRow" title="Supprimer">üóëÔ∏è</button></td>';
    tr.querySelector('.name').textContent=(m.nom||'').trim();
    tr.querySelector('.pre').textContent=(m.prenom||'').trim();
    tr.querySelector('.gsm').textContent=normGSM((m.gsm||'').trim());
    tr.querySelector('.mail').textContent=(m.mail||'').trim();
    tr.querySelector('.mail').setAttribute('title', (m.mail||''));
    return tr;
  }

  function rebuild(){
    var tb=$('#tbody'); tb.innerHTML='';
    var r=loadRoster(); r.forEach(m=>tb.appendChild(makeRow(m)));
    $('#inscritsCounter').textContent=r.length;
    diag('JS OK ‚Äî lignes: '+r.length);
    updateCounts();
    setColsVisibility(true);
  }

  function applyRowStates(){
    $$('#tbl tbody tr').forEach(function(tr){
      tr.classList.remove('state-green','state-red','state-yellow');
      var present=tr.querySelector('.pres input').checked;
      var txt=(tr.querySelector('.amount input').value||'').trim();
      var amt=txt===''? null:(parseFloat(txt.replace(',','.'))||0);
      if(present){
        if(amt===null) tr.classList.add('state-yellow');
        else if(amt>0) tr.classList.add('state-green');
        else tr.classList.add('state-red');
      }
    });
  }

  function updateCounts(){
    var present=0,free=0,zero=0,paidCount=0,paidSum=0;
    $$('#tbl tbody tr').forEach(function(tr){
      var cb=tr.querySelector('.pres input');
      var txt=(tr.querySelector('.amount input').value||'').trim();
      var amt=txt===''? null:(parseFloat(txt.replace(',','.'))||0);
      if(cb.checked){
        present++;
        if(amt===null) free++;
        else if(amt===0) zero++;
        else if(amt>0){ paidCount++; paidSum+=amt; }
      }
      tr.querySelector('.gsm').textContent=normGSM(tr.querySelector('.gsm').textContent);
    });
    $('#countPresence').textContent=String(present);
    $('#countFree').textContent=String(free);
    $('#countZero').textContent=String(zero);
    $('#countPaid').textContent=String(paidCount);
    $('#sumPaid').textContent=paidSum.toFixed(1).replace('.',',');
    applyRowStates();
  }

  document.addEventListener('input',function(e){
    if(e.target && e.target.matches('.amount input')){
      var tr=e.target.closest('tr');
      tr.querySelector('.pres input').checked = (e.target.value||'').trim()!=='';
      updateCounts();
    }
  });
  document.addEventListener('change',function(e){
    if(e.target && e.target.matches('.pres input')){
      var tr=e.target.closest('tr');
      if(!e.target.checked) tr.querySelector('.amount input').value='';
      updateCounts();
    }
  });

  document.addEventListener('click',function(e){
    if(e.target && e.target.matches('.editRow')){
      var tr=e.target.closest('tr');
      var n=tr.querySelector('.name').textContent.trim(),
          p=tr.querySelector('.pre').textContent.trim(),
          g=tr.querySelector('.gsm').textContent.trim(),
          m=tr.querySelector('.mail').textContent.trim();
      tr.dataset.orig=[n,p,g,m].join('|');
      tr.querySelector('.name').innerHTML='<input class="e-name" value="'+n.replace(/"/g,'&quot;')+'">';
      tr.querySelector('.pre').innerHTML='<input class="e-pre" value="'+p.replace(/"/g,'&quot;')+'">';
      tr.querySelector('.gsm').innerHTML='<input class="e-gsm" value="'+g.replace(/"/g,'&quot;')+'">';
      tr.querySelector('.mail').innerHTML='<input class="e-mail" value="'+m.replace(/"/g,'&quot;')+'">';
      e.target.textContent='üíæ'; e.target.classList.add('saveRow'); e.target.classList.remove('editRow');
    } else if(e.target && e.target.matches('.saveRow')){
      var tr=e.target.closest('tr');
      var n=tr.querySelector('.e-name').value.trim(),
          p=tr.querySelector('.e-pre').value.trim(),
          g=tr.querySelector('.e-gsm').value.trim(),
          m=tr.querySelector('.e-mail').value.trim();
      var r=loadRoster();
      var parts=(tr.dataset.orig||'|||').split('|');
      var idx=r.findIndex(function(x){ return (x.nom||'')===parts[0] && (x.prenom||'')===parts[1] && (x.gsm||'')===parts[2] && (x.mail||'')===parts[3]; });
      if(idx>=0) r[idx]={nom:n,prenom:p,gsm:g,mail:m}; else r.push({nom:n,prenom:p,gsm:g,mail:m});
      saveRoster(r); rebuild(); toast('Membre modifi√© ‚úÖ');
    } else if(e.target && e.target.matches('.deleteRow')){
      var tr=e.target.closest('tr');
      var parts=[tr.querySelector('.name').textContent.trim(),tr.querySelector('.pre').textContent.trim(),tr.querySelector('.gsm').textContent.trim(),tr.querySelector('.mail').textContent.trim()];
      var r=loadRoster().filter(function(x){ return !(((x.nom||'')===parts[0])&&((x.prenom||'')===parts[1])&&((x.gsm||'')===parts[2])&&((x.mail||'')===parts[3])); });
      saveRoster(r); rebuild(); toast('Membre supprim√© üóëÔ∏è');
    } else if(e.target && e.target.id==='toggleGsmMail'){
      setColsVisibility(!colsHidden);
    } else if(e.target && e.target.id==='toggleAddForm'){
      var f=document.getElementById('addForm'); f.style.display=(f.style.display==='none'?'flex':'none'); if(f.style.display==='') f.style.display='flex';
    } else if(e.target && e.target.id==='addMember'){
      var n=document.getElementById('addNom').value.trim(),
          p=document.getElementById('addPrenom').value.trim(),
          g=document.getElementById('addGsm').value.trim(),
          m=document.getElementById('addMail').value.trim();
      if(!n && !p && !g){ toast('Nom ou GSM requis'); return; }
      var r=loadRoster(); r.push({nom:n,prenom:p,gsm:g,mail:m}); saveRoster(r); rebuild();
      document.getElementById('addNom').value=document.getElementById('addPrenom').value=document.getElementById('addGsm').value=document.getElementById('addMail').value='';
      toast('Membre ajout√© ‚úÖ');
    } else if(e.target && e.target.id==='copyTable'){
      var lines=['Pr√©sence;‚Ç¨;Nom;Pr√©nom'];
      $$('#tbl tbody tr').forEach(function(tr){
        var pres = tr.querySelector('.pres input').checked ? '1' : '0';
        var amtTxt = (tr.querySelector('.amount input').value||'').trim();
        if(amtTxt){ var n = parseFloat(amtTxt.replace(',','.')); amtTxt = isNaN(n) ? '' : n.toFixed(1).replace('.',','); }
        var nom = tr.querySelector('.name').textContent.trim();
        var pre = tr.querySelector('.pre').textContent.trim();
        lines.push([pres, amtTxt, nom, pre].join(';'));
      });
      var text = lines.join('\r\n');
      function fallbackCopy(){ var ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('Copi√© ‚úÖ'); }
      if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(function(){ toast('Copi√© ‚úÖ'); }).catch(fallbackCopy); } else { fallbackCopy(); }
    } else if(e.target && e.target.id==='importCsvReplace'){
      (async function(){
        var f=document.getElementById('importCsv').files[0]; if(!f){ toast('Choisis un CSV'); return; }
        var txt=await f.text(); var lines=txt.trim().split(/\r?\n/); var sep=lines[0].indexOf(';')>=0?';':',';
        var cols=lines[0].split(sep).map(function(s){return s.trim().toLowerCase();});
        function idx(n){ return cols.findIndex(function(c){ return new RegExp(n).test(c); }); }
        var iNom=idx('^nom$'), iPre=idx('^pr|^pre'), iGsm=idx('gsm|t|mobile'), iMail=idx('mail|email');
        var r=[];
        for(var i=1;i<lines.length;i++){ var c=lines[i].split(sep); r.push({nom:(c[iNom]||'').trim(),prenom:(c[iPre]||'').trim(),gsm:String(c[iGsm]||'').trim(),mail:(c[iMail]||'').trim()}); }
        saveRoster(r); rebuild(); toast('Liste remplac√©e ‚úÖ');
      })();
    } else if(e.target && e.target.id==='resetRoster'){
      try{localStorage.removeItem(rosterKey);}catch(e){}
      rebuild(); toast('Liste r√©initialis√©e ‚ôªÔ∏è');
    } else if(e.target && e.target.id==='saveRoster'){
      saveRoster(loadRoster()); toast('Liste sauvegard√©e üíæ');
    } else if(e.target && e.target.id==='exportPDF'){
      window.print();
    }
  });

  document.getElementById('resetFields').addEventListener('click', function(){ 
    $$('#tbl tbody tr').forEach(function(tr){ tr.querySelector('.pres input').checked=false; tr.querySelector('.amount input').value=''; });
    updateCounts(); toast('Pr√©sence/‚Ç¨ remis √† z√©ro üßπ');
  });

  document.getElementById('sessionDate').value=(new Date()).toISOString().slice(0,10);
  diag("Chargement des donn√©es‚Ä¶");
  rebuild();
  setColsVisibility(true);
})();
</script>
<script>
(function(){
  // Find the toolbar container
  function findToolbar(){
    var candidates = document.querySelectorAll('.controls, .toolbar, .actions, #toolbar');
    if (candidates.length) return candidates[0];
    // fallback: first parent that contains multiple buttons
    var btns = document.querySelectorAll('button');
    if (!btns.length) return null;
    var p = btns[0].closest('div, header, section');
    return p || btns[0].parentNode;
  }

  function qButtons(scope){
    return (scope || document).querySelectorAll('button, .button, [role="button"]');
  }

  function findBtnByIdOrText(id, textsRe, emoji){
    if (id){
      var el = document.getElementById(id);
      if (el) return el;
    }
    var re = textsRe ? new RegExp(textsRe, 'i') : null;
    var list = qButtons();
    for (var i=0;i<list.length;i++){
      var b = list[i];
      var t = (b.textContent || '').trim();
      var title = (b.getAttribute('title') || '').trim();
      if (emoji && (t.includes(emoji) || title.includes(emoji))) return b;
      if (re && (re.test(t) || re.test(title))) return b;
      // Also check data-* labels if any
      var aria = (b.getAttribute('aria-label')||'') + ' ' + (b.getAttribute('data-label')||'');
      if (re && re.test(aria)) return b;
    }
    return null;
  }

  function ensureFlex(container){
    var cs = getComputedStyle(container);
    if (cs.display !== 'flex'){
      // Don't break existing styling; only force flex if it isn't already
      container.style.display = 'flex';
      container.style.flexWrap = 'wrap';
      container.style.gap = container.style.gap || '8px';
      container.style.alignItems = container.style.alignItems || 'center';
    }
  }

  function init(){
    var bar = findToolbar();
    if (!bar) return;

    ensureFlex(bar);

    // Identify buttons
    var btnResetList = findBtnByIdOrText('btnReset','^r√©initialiser(\\s+la\\s+liste)?$|^r√©initialiser la liste|^r√©initialiser$', '');
    var btnPrint     = findBtnByIdOrText('btnPrint','imprimer|print','');
    var btnEye       = findBtnByIdOrText('btnExpand','montrer|cacher|afficher','üëÅ');
    var btnSave      = findBtnByIdOrText('btnSave','sauver|sauvegarder','');
    var btnResetCases= findBtnByIdOrText('btnResetCases','reset(\\s+des)?\\s*cases|r√©initialiser\\s*cases|cases','');
    var btnResetEuro = findBtnByIdOrText('btnResetEuro','‚Ç¨|euro|paiement|payer|reinit(ialiser)?\\s*‚Ç¨','‚Ç¨');
    var btnCopy      = findBtnByIdOrText('btnCopy','copier|copy','');

    // Build right-hand sequence (only append those that exist)
    var rightOrder = [];
    if (btnPrint) rightOrder.push(btnPrint);
    if (btnEye) rightOrder.push(btnEye);
    if (btnSave) rightOrder.push(btnSave);
    // Some apps have a single button that resets both "cases & ‚Ç¨". If we found both, keep their current doc order.
    var pairs = [];
    if (btnResetCases) pairs.push(btnResetCases);
    if (btnResetEuro)  pairs.push(btnResetEuro);
    for (var i=0;i<pairs.length;i++) rightOrder.push(pairs[i]);
    if (btnCopy) rightOrder.push(btnCopy);

    // Create a dedicated left reset (reuse existing element)
    var leftReset = btnResetList;
    if (!leftReset){
      // fallback: create one if not present
      leftReset = document.createElement('button');
      leftReset.id = 'btnResetListFinal';
      leftReset.textContent = 'R√©initialiser la liste';
      bar.insertBefore(leftReset, bar.firstChild);
    } else {
      // Assign an id we can style, if not already
      leftReset.id = leftReset.id || 'btnResetListFinal';
    }

    // Confirmation + red style
    try{
      leftReset.addEventListener('click', function(ev){
        var ok = confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser la liste ?');
        if (!ok){ ev.preventDefault(); ev.stopPropagation(); return false; }
        if (typeof window.resetList === 'function' && !leftReset.hasAttribute('onclick')){
          ev.preventDefault(); ev.stopPropagation();
          setTimeout(function(){ window.resetList(); }, 0);
          return false;
        }
      }, true);
      leftReset.style.backgroundColor = '#dc3545';
      leftReset.style.borderColor = '#dc3545';
      leftReset.style.color = '#fff';
    }catch(e){}

    // Now physically reorder: Left reset first, then a spacer, then right sequence in the requested order.
    // Insert left at start
    try { bar.insertBefore(leftReset, bar.firstChild); } catch(e){}

    // Spacer
    var spacer = document.createElement('div');
    spacer.className = 'toolbar-spacer-flex';
    // Insert spacer right after left reset
    try {
      if (!bar.querySelector('.toolbar-spacer-flex')){
        if (leftReset.nextSibling) bar.insertBefore(spacer, leftReset.nextSibling);
        else bar.appendChild(spacer);
      } else {
        spacer = bar.querySelector('.toolbar-spacer-flex');
      }
    } catch(e){}

    // Append right group in order (moving existing nodes; no duplicates)
    for (var i=0;i<rightOrder.length;i++){
      var btn = rightOrder[i];
      if (!btn || !btn.parentNode) continue;
      try { bar.appendChild(btn); } catch(e){}
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }
})();
</script>
<script>
(function(){
  function ymdToDmy(ymd){
    if(!ymd || ymd.indexOf('-') === -1) return '';
    var p = ymd.split('-'); if(p.length<3) return '';
    return p[2]+'/'+p[1]+'/'+p[0];
  }
  function updateHeaderDate(){
    var src = document.getElementById('sessionDate');
    var dst = document.getElementById('dateHeader');
    if(!src || !dst) return;
    var v = src.value || new Date().toISOString().slice(0,10);
    dst.textContent = ymdToDmy(v);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', updateHeaderDate);
  } else { updateHeaderDate(); }
  document.addEventListener('change', function(e){
    if(e && e.target && e.target.id==='sessionDate') updateHeaderDate();
  });
})();
</script>
<script>
(function(){
  function findToolbar(){
    var cands = document.querySelectorAll('.controls, .toolbar, .actions, #toolbar');
    if (cands.length) return cands[0];
    var btns = document.querySelectorAll('button');
    return btns.length ? (btns[0].closest('div, header, section') || btns[0].parentNode) : null;
  }
  function qButtons(){ return document.querySelectorAll('button, .button, [role="button"]'); }
  function findBtn(id, txtRe, emoji){
    var el = id ? document.getElementById(id) : null;
    if (el) return el;
    var re = txtRe ? new RegExp(txtRe,'i') : null;
    var list = qButtons();
    for (var i=0;i<list.length;i++){
      var b=list[i], t=(b.textContent||'').trim(), title=(b.getAttribute('title')||'').trim();
      if (emoji && (t.includes(emoji)||title.includes(emoji))) return b;
      if (re && (re.test(t)||re.test(title))) return b;
      var aria=(b.getAttribute('aria-label')||'')+' '+(b.getAttribute('data-label')||'');
      if (re && re.test(aria)) return b;
    }
    return null;
  }
  function ensureFlex(bar){
    var cs=getComputedStyle(bar);
    if (cs.display!=='flex'){ bar.style.display='flex'; bar.style.flexWrap='wrap'; bar.style.gap=bar.style.gap||'8px'; bar.style.alignItems=bar.style.alignItems||'center'; }
  }
  function ensureConfirmRed(btn){
    if (!btn) return;
    btn.addEventListener('click', function(ev){
      var ok = confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser la liste ?');
      if (!ok){ ev.preventDefault(); ev.stopPropagation(); return false; }
      if (typeof window.resetList === 'function' && !btn.hasAttribute('onclick')){
        ev.preventDefault(); ev.stopPropagation(); setTimeout(function(){ window.resetList(); }, 0);
        return false;
      }
    }, true);
    btn.style.backgroundColor='#dc3545'; btn.style.borderColor='#dc3545'; btn.style.color='#fff';
  }
  function init(){
    var bar = findToolbar(); if(!bar) return;
    ensureFlex(bar);
    // Identify buttons
    var btnResetList = findBtn('btnReset','^r√©initialiser(\s+la\s+liste)?$|^r√©initialiser la liste|^r√©initialiser$','');
    var btnPrint     = findBtn('btnPrint','imprimer|print','');
    var btnEye       = findBtn('btnExpand','montrer|cacher|afficher','üëÅ');
    var btnSave      = findBtn('btnSave','sauver|sauvegarder|enregistrer','');
    var btnResetCases= findBtn('btnResetCases','reset(\s+des)?\s*cases|r√©initialiser\s*cases|cases','');
    var btnResetEuro = findBtn('btnResetEuro','‚Ç¨|euro|paiement|payer|reinit(ialiser)?\s*‚Ç¨','‚Ç¨');
    var btnCopy      = findBtn('btnCopy','copier|copy','');
    // LEFT: reset list
    if (btnResetList){ try{ bar.insertBefore(btnResetList, bar.firstChild); }catch(e){} }
    ensureConfirmRed(btnResetList);
    // Spacer
    var spacer = bar.querySelector('.toolbar-spacer-flex'); if(!spacer){ spacer=document.createElement('div'); spacer.className='toolbar-spacer-flex'; bar.appendChild(spacer); }
    // RIGHT order
    var rightBtns = [btnPrint, btnEye, btnSave];
    if (btnResetCases) rightBtns.push(btnResetCases);
    if (btnResetEuro)  rightBtns.push(btnResetEuro);
    if (btnCopy)       rightBtns.push(btnCopy);
    for (var i=0;i<rightBtns.length;i++){ var b=rightBtns[i]; if(b && b.parentNode){ try{ bar.appendChild(b); }catch(e){} } }
  }
  if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
})();
</script>
<script id="eneo-oneconfirm-v48">
(function(){
  const btn = document.getElementById("resetRoster");
  if(!btn) return;
  let guard = false;
  document.addEventListener("click", function(ev){
    const el = ev.target.closest && ev.target.closest("#resetRoster");
    if(!el) return;
    ev.preventDefault(); ev.stopImmediatePropagation();
    if(guard) return; guard = true;
    const ok = confirm("‚ö†Ô∏è R√©initialiser compl√®tement la LISTE (pr√©sences et montants ‚Ç¨) ?");
    guard = false;
    if(!ok) return;
    try {
      ["eneo-contacts-v4-state","eneo-v4-persist","eneo-v4-state2"].forEach(k => localStorage.removeItem(k));
    } catch(e){}
    // Reset UI (checkboxes, euros, colors)
    document.querySelectorAll("tbody tr").forEach(tr=>{
      const cb = tr.querySelector('.pres input[type="checkbox"], input.present, input[type="checkbox"].present') || tr.querySelector('.pres input[type="checkbox"]');
      const euro = tr.querySelector('.amount input, input.euro');
      if(cb) cb.checked = false;
      if(euro) euro.value = "";
      tr.classList.remove("state-yellow","state-red","state-green");
    });
    // Counters
    const cp = document.querySelector("#countPresent");
    const te = document.querySelector("#totalEuro");
    if(cp) cp.textContent = "0";
    if(te) te.textContent = "0";
  }, true);
  // Spacer width = button width
  requestAnimationFrame(()=>{
    const s = btn.nextElementSibling;
    if(s && s.classList.contains("btn-spacer")){
      s.style.width = (btn.getBoundingClientRect().width + 8) + "px";
    }
  });
})();
</script>
<script id="eneo-stability-v49c">
(function(){
  const KEY = "eneo-v4-state2"; // keep same key so the existing reset clears it
  const $ = (q, r=document) => r.querySelector(q);
  const $$ = (q, r=document) => Array.from(r.querySelectorAll(q));
  const norm = s => (s||"").normalize("NFKC").trim().replace(/\s+/g," ");

  function rowKeyFromCells(tr){
    const nom  = norm((tr.querySelector("td.name") || tr.cells?.[1] || {}).textContent || "");
    const pre  = norm((tr.querySelector("td.pre")  || tr.cells?.[2] || {}).textContent || "");
    const gsm  = norm((tr.querySelector("td.gsm")  || tr.cells?.[3] || {}).textContent || "").replace(/^0+/,'');
    const mail = norm((tr.querySelector("td.mail") || tr.cells?.[4] || {}).textContent || "").toLowerCase();
    const raw  = [nom, pre, gsm, mail].join("|");
    let h = 0; for (let i=0;i<raw.length;i++){ h=((h<<5)-h)+raw.charCodeAt(i); h|=0; }
    return nom+"|"+pre+"|"+(gsm||"-")+"|"+(mail||"-")+"#"+(h>>>0).toString(36);
  }
  function rowKey(tr){
    const id = tr.getAttribute("data-id") || (tr.dataset && tr.dataset.id);
    return id ? "id:"+id : "k:"+rowKeyFromCells(tr);
  }

  const load = () => { try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch(e){ return {}; } };
  const save = (st) => { try { localStorage.setItem(KEY, JSON.stringify(st)); } catch(e){} };
  let state = load();

  function parseEuro(raw){
    if(raw == null) return {empty:true, value:0};
    const s = String(raw).trim();
    if(s==="") return {empty:true, value:0};
    const v = parseFloat(s.replace(",", "."));
    return {empty:false, value: isNaN(v)?0:v};
  }
  function setRowClass(tr, cls){
    tr.classList.remove("state-yellow","state-red","state-green");
    if(cls) tr.classList.add(cls);
  }
  function updateRowColorFromUI(tr){
    const cb   = tr.querySelector('.pres input[type="checkbox"], input.present, input[type="checkbox"].present') || tr.querySelector('.pres input[type="checkbox"]');
    const euro = tr.querySelector('.amount input, input.euro');
    if(!cb || !cb.checked){ setRowClass(tr,null); return; }
    const p = parseEuro(euro && euro.value);
    if(p.empty) setRowClass(tr,"state-yellow");
    else if(p.value<=0) setRowClass(tr,"state-red");
    else setRowClass(tr,"state-green");
  }

  function applyOnce(){
    const rows = $$("tbody tr");
    rows.forEach(tr => {
      const k = rowKey(tr);
      const s = state[k];
      const cb   = tr.querySelector('.pres input[type="checkbox"], input.present, input[type="checkbox"].present') || tr.querySelector('.pres input[type="checkbox"]');
      const euro = tr.querySelector('.amount input, input.euro');
      if(s){
        if(cb) cb.checked = !!s.p;
        if(euro) euro.value = (s.e==null ? "" : String(s.e));
      }
      updateRowColorFromUI(tr);
    });
    updateCounters();
  }

  function updateCounters(){
    const tbody = $("tbody");
    if(!tbody) return;
    let present = 0, total = 0;
    $$("tr", tbody).forEach(tr => {
      const cb = tr.querySelector('.pres input[type="checkbox"], input.present, input[type="checkbox"].present') || tr.querySelector('.pres input[type="checkbox"]');
      const euro = tr.querySelector('.amount input, input.euro');
      if(cb && cb.checked) present += 1;
      if(euro){
        const v = parseFloat(String(euro.value||"").replace(",", "."));
        total += isNaN(v) ? 0 : v;
      }
    });
    const cp = $("#countPresent"); if(cp) cp.textContent = String(present);
    const te = $("#totalEuro");   if(te) te.textContent = String(total).replace('.', ',');
  }
  // expose for others (if needed)
  window.__updateEneoCounters = updateCounters;

  function bindDelegated(){
    const tbody = $("tbody"); if(!tbody) return;
    tbody.addEventListener("change", ev => {
      const t = ev.target, tr = t.closest && t.closest("tr");
      if(!tr) return;
      const k = rowKey(tr); if(!k) return;
      state[k] = state[k] || {};
      if(t.matches('.pres input[type="checkbox"], input.present, input[type="checkbox"].present')){
        state[k].p = !!t.checked;
      } else if (t.matches('input.euro, .amount input[type="number"]')){
        state[k].e = String(t.value||"");
      }
      save(state);
      updateRowColorFromUI(tr);
      updateCounters();
    }, false);

    tbody.addEventListener("input", ev => {
      const t = ev.target;
      if(!t.matches('input.euro, .amount input[type="number"]')) return;
      const tr = t.closest && t.closest("tr"); if(!tr) return;
      const k  = rowKey(tr); state[k] = state[k] || {};
      state[k].e = String(t.value||"");
      save(state);
      updateRowColorFromUI(tr);
      updateCounters();
    }, false);
  }

  // Save a snapshot when the page goes hidden (lock screen / app switch)
  document.addEventListener("visibilitychange", () => {
    if(document.visibilityState !== "hidden") return;
    const rows = $$("tbody tr");
    rows.forEach(tr => {
      const k = rowKey(tr);
      if(!k) return;
      const cb   = tr.querySelector('.pres input[type="checkbox"], input.present, input[type="checkbox"].present') || tr.querySelector('.pres input[type="checkbox"]');
      const euro = tr.querySelector('.amount input, input.euro');
      state[k] = state[k] || {};
      if(cb)   state[k].p = !!cb.checked;
      if(euro) state[k].e = String(euro.value||"");
    });
    save(state);
  });

  // On wake / back to foreground (Safari iOS fires pageshow), re-apply with retries
  window.addEventListener("pageshow", () => {
    [50, 150, 400, 1000].forEach(d => setTimeout(applyOnce, d));
  });

  document.addEventListener("DOMContentLoaded", () => {
    [0, 80, 250].forEach(d => setTimeout(applyOnce, d));
    bindDelegated();
    // Short-lived observer (2s) to catch one rebuild of tbody
    const tb = document.querySelector("tbody");
    if(tb && "MutationObserver" in window){
      const obs = new MutationObserver(() => { applyOnce(); });
      obs.observe(tb, {childList:true, subtree:false});
      setTimeout(() => { try{ obs.disconnect(); }catch(e){} }, 2000);
    }
  });
})();
</script>
</body></html>
