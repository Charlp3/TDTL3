<!doctype html>
<html lang="fr" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <title>TDTL v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0a84ff" />
  <style>
    :root{
      --upper:#d9dae0; --page:#e5e5ea; --panel:#ffffff;
      --ink:#111; --sub:#555; --border:#c7c8ce; --accent:#007aff;
      --ok:#28cd41; --warn:#ffcc00; --bad:#ff3b30;
      --head-dark:#3a3a3c;
      --fab-h:60px;
      --sheet-bg:#ffffff; --sheet-text:#111;
      --table-head-text:#f2f2f7;
      --toast-bg:#111; --toast-fg:#fff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --upper:#1c1c1e; --page:#111113; --panel:#1a1a1d;
        --ink:#e6e6eb; --sub:#a1a1a7; --border:#2c2c2e; --accent:#0a84ff;
        --ok:#30d158; --warn:#ffd60a; --bad:#ff453a;
        --head-dark:#1f1f22; --sheet-bg:#161618; --sheet-text:#eaeaf0; --table-head-text:#d8d8df;
        --toast-bg:#0b0b0d; --toast-fg:#fff;
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Helvetica,Arial,sans-serif;
         background:linear-gradient(180deg,var(--upper) 0%, var(--page) 420px, var(--page) 100%)}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:var(--upper);border-bottom:1px solid var(--border);
           padding:calc(4px + env(safe-area-inset-top)) 12px 4px}
    h1{margin:0;font-size:1rem;font-weight:700;display:flex;align-items:center;gap:6px}
    .version{font-size:.8rem;color:var(--sub)}

    .wrap{max-width:1100px;margin:0 auto;padding:12px 12px calc(var(--fab-h) + 16px)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden}

    /* Panneau supérieur */
    .toolbar{display:flex;gap:8px;padding:8px;align-items:center;justify-content:flex-start;flex-wrap:wrap;
             background:var(--upper);border-bottom:1px solid var(--border)}
    .btn{height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:.9rem;font-weight:600;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0a84ff,#007aff);color:#fff;border:none}
    .btn.danger{background:#fff0f0;color:#b10000;border-color:#ffd1d1}

    .displayBar{display:flex;gap:10px;align-items:center;padding:6px 8px;background:var(--upper);border-top:1px solid var(--border);border-bottom:1px solid var(--border);font-size:.95rem}
    .pill{background:#fff;border:1px solid var(--border);padding:4px 10px;border-radius:999px}

    /* Formulaire d'ajout (sans montant ni présent) */
    form.add{
      display:grid;grid-template-columns:repeat(4,1fr) auto;gap:10px;padding:8px;background:var(--upper);border-bottom:1px solid var(--border)
    }
    label{font-size:.8rem;color:var(--sub);margin:0 0 4px}
    input,select{
      width:100%;height:40px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:1rem
    }
    .full{grid-column:1/-1}

    /* Liste zébrée */
    .tblWrap{max-height:60svh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:820px}
    thead th{position:sticky;top:0;z-index:30;padding:8px;text-align:left;font-size:.8rem;color:var(--table-head-text);background:var(--head-dark)}
    tbody td{padding:10px;border-bottom:1px solid var(--border);font-size:.95rem}
    tbody tr:nth-child(odd){background:#f3f3f6}
    tbody tr:nth-child(even){background:#e6e6eb}
    @media (prefers-color-scheme: dark){
      tbody tr:nth-child(odd){background:#2c2c2e}
      tbody tr:nth-child(even){background:#3a3a3c}
    }

    .nameCell{display:flex;align-items:center;gap:10px;cursor:pointer}
    .nameBadge{width:10px;height:10px;border-radius:50%;display:inline-block;border:1px solid rgba(0,0,0,.1)}
    .nameBadge.green{background:#28cd41;border-color:#1e9731}
    .nameBadge.red{background:#ff3b30;border-color:#d62a21}
    .nameBadge.yellow{background:#ffcc00;border-color:#e0b500}

    .presentCell input{transform:scale(1.15)}
    .money input{max-width:110px}
    .hiddenCol{display:none}
    .rowActions{display:flex;gap:8px;align-items:center}

    /* Barre basse */
    .fabBar{position:fixed;left:0;right:0;bottom:0;z-index:50;background:rgba(250,250,252,.96);backdrop-filter:blur(8px);border-top:1px solid var(--border);
            padding:8px;display:flex;gap:8px}
    .fabBar .btn{flex:1}

    /* Sheets */
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:60;background:var(--sheet-bg);color:var(--sheet-text);
           border-radius:12px 12px 0 0;box-shadow:0 -6px 20px rgba(0,0,0,.25);transform:translateY(100%);transition:.25s;padding:12px;max-height:70svh;overflow:auto}
    .sheet.show{transform:translateY(0)}
    .sheet h3{margin:0 0 10px}
    .sheet .row{display:grid;grid-template-columns:120px 1fr;gap:10px;margin-bottom:10px}
    .sheet .actions{display:flex;gap:10px;justify-content:flex-end}

    .toast{position:fixed;bottom:calc(var(--fab-h) + 12px);right:16px;background:var(--toast-bg);color:var(--toast-fg);
           padding:8px 12px;border-radius:8px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <h1>TDTL <span class="version">v2.0</span></h1>
  </header>

  <div class="wrap">
    <div class="card">

      <!-- Panneau supérieur minimal -->
      <div class="toolbar">
        <button class="btn" id="btnImport">Importer</button>
        <button class="btn" id="btnOptions">Options</button>
      </div>

      <div class="displayBar">
        <span class="pill">Présents: <strong id="statPresents">0</strong></span>
        <span class="pill">Total: <strong id="statTotal">0,00 €</strong></span>
      </div>

      <!-- Formulaire d'ajout (Sans Montant & Présent) -->
      <form class="add" id="addForm" novalidate>
        <div><label>Prénom</label><input id="prenom" required autocomplete="given-name" placeholder="Jean"></div>
        <div><label>Nom</label><input id="nom" required autocomplete="family-name" placeholder="Dupont"></div>
        <div><label>Tel (04XXXXXXXX)</label><input id="tel" maxlength="10" inputmode="numeric" placeholder="0412345678"></div>
        <div><label>Mail</label><input id="mail" type="email" placeholder="ex: joueur@mail.fr"></div>
        <button class="btn primary" type="submit">Ajouter</button>
      </form>

      <!-- Liste -->
      <div class="tblWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:40px"><input type="checkbox" id="selectAll"></th>
              <th>Nom & Prénom</th>
              <th class="th-tel">Téléphone</th>
              <th class="th-mail">E-mail</th>
              <th class="presentCell">Présent</th>
              <th>Montant (€)</th>
              <th style="width:140px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="empty" style="display:none; padding:12px; text-align:center; color:var(--sub)">Aucun joueur.</div>
    </div>
  </div>

  <!-- Barre basse -->
  <div class="fabBar">
    <button class="btn danger" id="deleteSelected">Supprimer</button>
    <button class="btn" id="exportNamesAmounts">Exporter</button>
    <button class="btn primary" id="saveAll">Sauver</button>
  </div>

  <!-- Sheet Options & Import -->
  <div id="sheetOptions" class="sheet" aria-hidden="true">
    <h3>Options & Import</h3>
    <div class="row">
      <label>Colonne Téléphone</label>
      <button class="btn" id="toggleTel">Afficher</button>
    </div>
    <div class="row">
      <label>Colonne E-mail</label>
      <button class="btn" id="toggleMail">Afficher</button>
    </div>
    <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
    <div class="row">
      <label>Fichier CSV</label>
      <input type="file" id="csvFile" accept=".csv,text/csv" />
    </div>
    <div class="row">
      <label>Mode import</label>
      <select id="importMode">
        <option value="append">Ajouter</option>
        <option value="replace">Remplacer</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn" id="closeOptions">Fermer</button>
      <button class="btn primary" id="importCsvBtn">Importer</button>
    </div>
  </div>

  <!-- Sheet Édition ligne -->
  <div id="sheetRow" class="sheet" aria-hidden="true">
    <h3 id="rowTitle">Édition</h3>
    <div class="row"><label>Nom</label><input id="rowNom"></div>
    <div class="row"><label>Prénom</label><input id="rowPrenom"></div>
    <div class="row"><label>Tel</label><input id="rowTel" maxlength="10" inputmode="numeric" placeholder="04XXXXXXXX"></div>
    <div class="row"><label>Mail</label><input id="rowMail" type="email" placeholder="ex: joueur@mail.fr"></div>
    <div class="actions">
      <button class="btn danger" id="rowDelete">Supprimer</button>
      <button class="btn" id="rowCancel">Annuler</button>
      <button class="btn primary" id="rowSave">Enregistrer</button>
    </div>
  </div>

  <div id="toast" class="toast">✔️</div>

<script>
/* ===== Helpers & état ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => (Number(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2, maximumFractionDigits:2});
const STORAGE_KEY = 'tdtl_v20_form_slim';
const phoneValid = v => !v || /^04\d{8}$/.test(String(v||'').trim());
const emailValid = v => !v || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim());
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }

let state = loadState();
function loadState(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw); }catch(e){}
  return {
    players:[
      {id:crypto.randomUUID(), prenom:'Pierre', nom:'CHARLIER', tel:'0412345678', mail:'', present:true,  montant:1},
      {id:crypto.randomUUID(), prenom:'Coco',   nom:'CICI',      tel:'',          mail:'', present:true,  montant:0},
    ],
    hideTel:true,   // ✅ masqué par défaut
    hideMail:true   // ✅ masqué par défaut
  };
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* ===== Rendu ===== */
function badgeClass(p){
  if(!p.present) return '';
  if(p.montant===null || p.montant==='' || typeof p.montant==='undefined') return 'yellow';
  const m=Number(p.montant); if(isNaN(m)) return 'yellow';
  if(m===0) return 'red';
  if(m>0) return 'green';
  return '';
}
function render(){
  // options UI
  $('#toggleTel').textContent  = state.hideTel  ? 'Afficher' : 'Masquer';
  $('#toggleMail').textContent = state.hideMail ? 'Afficher' : 'Masquer';
  $('.th-tel')?.classList.toggle('hiddenCol', state.hideTel);
  $('.th-mail')?.classList.toggle('hiddenCol', state.hideMail);

  const tbody = $('#tbody'); tbody.textContent='';
  if(state.players.length===0) $('#empty').style.display='block'; else $('#empty').style.display='none';

  for(const p of state.players){
    const tr = document.createElement('tr');

    // Sélecteur
    const tdSel = document.createElement('td');
    tdSel.innerHTML = `<input type="checkbox" class="rowSel" data-id="${p.id}">`;
    tr.appendChild(tdSel);

    // Nom & Prénom (clic -> fiche)
    const tdName = document.createElement('td');
    const nameBox = document.createElement('div'); nameBox.className='nameCell'; nameBox.title='Éditer';
    const badge = document.createElement('span'); badge.className='nameBadge ' + badgeClass(p);
    const nameText = document.createElement('span'); nameText.textContent = `${p.nom.toUpperCase()} ${p.prenom}`;
    nameBox.append(badge, nameText); tdName.appendChild(nameBox); tr.appendChild(tdName);
    nameBox.addEventListener('click', ()=> openRowSheet(p.id));

    // Tel (masqué par défaut)
    const tdTel = document.createElement('td'); tdTel.className = state.hideTel ? 'hiddenCol' : '';
    tdTel.textContent = p.tel || '—'; tr.appendChild(tdTel);

    // Mail (masqué par défaut)
    const tdMail = document.createElement('td'); tdMail.className = state.hideMail ? 'hiddenCol' : '';
    tdMail.textContent = p.mail || '—'; tr.appendChild(tdMail);

    // Présent
    const tdPres = document.createElement('td'); tdPres.className='presentCell';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!p.present;
    cb.addEventListener('change', ()=>{ p.present=cb.checked; save(); render(); });
    tdPres.appendChild(cb); tr.appendChild(tdPres);

    // Montant
    const tdMoney = document.createElement('td');
    const m = document.createElement('input'); m.type='number'; m.inputMode='decimal'; m.min='0'; m.step='0.01'; m.style.maxWidth='110px';
    m.value = (p.montant===null || typeof p.montant==='undefined') ? '' : String(p.montant);
    m.addEventListener('input', ()=>{ const v=m.value.trim(); p.montant = v==='' ? null : Number(v); save(); render(); });
    tdMoney.appendChild(m); tr.appendChild(tdMoney);

    // Actions
    const tdAct = document.createElement('td'); tdAct.className='rowActions';
    const edit = document.createElement('button'); edit.className='btn'; edit.textContent='✎'; edit.onclick=()=>openRowSheet(p.id);
    const del  = document.createElement('button'); del.className='btn danger'; del.textContent='Suppr';
    del.onclick=()=>{ if(confirm(`Supprimer ${p.prenom} ${p.nom} ?`)){ state.players = state.players.filter(x=>x.id!==p.id); save(); render(); } };
    tdAct.append(edit, del); tr.appendChild(tdAct);

    tbody.appendChild(tr);
  }

  // Stats
  const presents = state.players.filter(p=>p.present);
  const total = presents.reduce((s,p)=> s + (Number(p.montant)>0 ? Number(p.montant) : 0), 0);
  $('#statPresents').textContent = String(presents.length);
  $('#statTotal').textContent = fmt(total)+' €';

  // Reset selectAll
  $('#selectAll').checked=false;
}

/* ===== Sheet ligne ===== */
let currentRowId = null;
function openRowSheet(id){
  currentRowId = id;
  const p = state.players.find(x=>x.id===id); if(!p) return;
  $('#rowTitle').textContent = `${p.nom.toUpperCase()} ${p.prenom}`;
  $('#rowNom').value = p.nom || '';
  $('#rowPrenom').value = p.prenom || '';
  $('#rowTel').value = p.tel || '';
  $('#rowMail').value = p.mail || '';
  $('#sheetRow').classList.add('show'); $('#sheetRow').setAttribute('aria-hidden','false');
}
function closeRowSheet(){ $('#sheetRow').classList.remove('show'); $('#sheetRow').setAttribute('aria-hidden','true'); currentRowId=null; }
$('#rowCancel').addEventListener('click', closeRowSheet);
$('#rowSave').addEventListener('click', ()=>{
  if(!currentRowId) return;
  const p = state.players.find(x=>x.id===currentRowId); if(!p) return;
  const nom = $('#rowNom').value.trim();
  const prenom = $('#rowPrenom').value.trim();
  const tel = $('#rowTel').value.trim();
  const mail = $('#rowMail').value.trim();
  if(!nom || !prenom){ alert('Nom et prénom requis.'); return; }
  if(!phoneValid(tel)){ alert('Téléphone invalide : 04 + 8 chiffres.'); return; }
  if(!emailValid(mail)){ alert('E-mail invalide.'); return; }
  p.nom = nom; p.prenom = prenom; p.tel = tel; p.mail = mail; save(); render(); toast('Modifié ✔️'); closeRowSheet();
});
$('#rowDelete').addEventListener('click', ()=>{
  if(!currentRowId) return;
  const p = state.players.find(x=>x.id===currentRowId); if(!p) return;
  if(confirm(`Supprimer ${p.prenom} ${p.nom} ?`)){
    state.players = state.players.filter(x=>x.id!==p.id); save(); render(); closeRowSheet();
  }
});

/* ===== Ajout / suppression / export ===== */
$('#addForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const prenom = $('#prenom').value.trim();
  const nom    = $('#nom').value.trim();
  const tel    = $('#tel').value.trim();
  const mail   = $('#mail').value.trim();
  if(!prenom || !nom){ alert('Nom et prénom requis.'); return; }
  if(!phoneValid(tel)){ alert('Téléphone invalide : 04 + 8 chiffres.'); return; }
  if(!emailValid(mail)){ alert('E-mail invalide.'); return; }
  state.players.unshift({ id:crypto.randomUUID(), prenom, nom, tel, mail, present:false, montant:null });
  save(); e.target.reset(); render(); toast('Ajouté ✔️');
});

$('#selectAll').addEventListener('change', e=> $$('.rowSel').forEach(cb=> cb.checked=e.target.checked));
$('#deleteSelected').addEventListener('click', ()=>{
  const ids = $$('.rowSel:checked').map(cb=>cb.dataset.id);
  if(!ids.length){ alert('Sélectionnez au moins un membre.'); return; }
  if(confirm(`Supprimer ${ids.length} membre(s) ?`)){
    state.players = state.players.filter(p=>!ids.includes(p.id)); save(); render(); toast('Supprimé ✔️');
  }
});

$('#saveAll').addEventListener('click', ()=>{ save(); toast('Sauvegardé ✔️'); });

$('#exportNamesAmounts').addEventListener('click', async ()=>{
  if(state.players.length===0){ alert('Rien à exporter.'); return; }
  const headers = ['Nom complet','Montant'];
  const rows = state.players.map(p=>[
    csvEscape(`${p.nom} ${p.prenom}`.trim()),
    (p.montant===null || typeof p.montant==='undefined') ? '' : String(p.montant)
  ]);
  const csv = [headers.join(';')].concat(rows.map(r=>r.join(';'))).join('\n');
  const filename = 'noms_montants.csv';
  try{
    if(navigator.canShare && navigator.canShare({ files:[new File([csv], filename, {type:'text/csv'})]})){
      await navigator.share({ files:[new File([csv], filename, {type:'text/csv'})], title:'Export', text:'Noms + Montants' });
    }else{
      downloadCsv(csv, filename);
    }
  }catch{ downloadCsv(csv, filename); }
});
function csvEscape(s){ s=String(s); return /[;"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
function downloadCsv(content, filename){
  const blob = new Blob([content], {type:"text/csv;charset=utf-8;"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove();
}

/* ===== Options & Import ===== */
const optSheet = $('#sheetOptions');
$('#btnOptions').addEventListener('click', ()=>{ optSheet.classList.add('show'); optSheet.setAttribute('aria-hidden','false'); });
$('#closeOptions').addEventListener('click', ()=>{ optSheet.classList.remove('show'); optSheet.setAttribute('aria-hidden','true'); });

$('#btnImport').addEventListener('click', ()=>{ optSheet.classList.add('show'); optSheet.setAttribute('aria-hidden','false'); $('#csvFile').focus(); });
$('#toggleTel').addEventListener('click', ()=>{ state.hideTel=!state.hideTel; save(); render(); });
$('#toggleMail').addEventListener('click', ()=>{ state.hideMail=!state.hideMail; save(); render(); });

/* ===== Import CSV robuste ===== */
(()=> {
  const fileInput=$('#csvFile'), importBtn=$('#importCsvBtn'), modeSel=$('#importMode');
  fileInput?.addEventListener('change', async ()=>{
    if(!fileInput.files?.[0]) return;
    await doImportCsv(fileInput.files[0], modeSel?.value || 'append');
    optSheet.classList.remove('show'); optSheet.setAttribute('aria-hidden','true');
    fileInput.value='';
  });
  importBtn?.addEventListener('click', async ()=>{
    const f=fileInput?.files?.[0]; if(!f){ alert('Choisissez un fichier CSV.'); return; }
    await doImportCsv(f, modeSel?.value || 'append');
    optSheet.classList.remove('show'); optSheet.setAttribute('aria-hidden','true');
    fileInput.value='';
  });
})();

async function doImportCsv(file, mode='append'){
  try{
    const text = await fileToTextSmart(file);
    const rows = parseCsvSmart(text);
    if(rows.length===0){ alert('CSV vide.'); return; }
    const mapped = mapCsvRows(rows);

    const valid = [];
    for(const r of mapped){
      const prenom = (r.prenom||'').trim();
      const nom    = (r.nom||'').trim();
      const tel    = (r.tel||'').trim();
      const mail   = (r.mail||'').trim();
      const present= !!r.present;
      const montant= (r.montant==='' || r.montant===null || typeof r.montant==='undefined') ? null : Number(r.montant);
      if(!prenom || !nom) continue;
      if(!phoneValid(tel)) continue; // vide OU 04xxxxxxxx
      if(!emailValid(mail)) continue;
      valid.push({ id:crypto.randomUUID(), prenom, nom, tel, mail, present, montant });
    }
    if(valid.length===0){ alert('Aucune ligne valide.'); return; }
    state.players = (mode==='replace') ? valid : valid.concat(state.players);
    save(); render(); toast(`Importé ${valid.length} ✔️`);
  }catch(err){ console.error(err); alert('Erreur import : '+(err?.message||err)); }
}
async function fileToTextSmart(file){
  const buf = await file.arrayBuffer();
  let text = new TextDecoder('utf-8', {fatal:false}).decode(buf);
  const repl=(text.match(/\uFFFD/g)||[]).length;
  if(repl>5){ try{ text=new TextDecoder('iso-8859-1',{fatal:false}).decode(buf); }catch{} }
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
}
function parseCsvWithSep(text, sep){
  const rows=[]; let row=[], field='', i=0, inQ=false;
  const pushField=()=>{ row.push(field); field=''; };
  const pushRow  =()=>{ rows.push(row); row=[]; };
  while(i<text.length){
    const c=text[i];
    if(inQ){ if(c=='"'){ if(text[i+1]=='"'){ field+='"'; i++; } else { inQ=false; } } else field+=c; }
    else{ if(c=='"') inQ=true; else if(c==sep) pushField(); else if(c=='\n'){ pushField(); pushRow(); } else if(c!='\r') field+=c; }
    i++;
  }
  pushField(); if(row.length>1 || row[0]!=='') pushRow();
  return rows.map(r=>r.map(x=>(x??'').trim())).filter(r=>r.some(x=>x!==''));
}
function detectDelimiter(text){
  const seps=['; ',',','\t','|']; let best=null, score=-Infinity;
  for(const s of seps){
    const parsed=parseCsvWithSep(text,s);
    const lens=parsed.map(r=>r.length).filter(n=>n>1);
    if(!lens.length) continue;
    const avg=lens.reduce((a,b)=>a+b,0)/lens.length;
    const variance=lens.reduce((acc,n)=>acc+(n-avg)*(n-avg),0)/lens.length;
    const sc=lens.length*avg-variance;
    if(sc>score){score=sc; best=parsed;}
  }
  return best||parseCsvWithSep(text,';');
}
function parseCsvSmart(text){ return detectDelimiter(text); }
function mapCsvRows(rows){
  if(rows.length===0) return [];
  const header = rows[0].map(h=>h.toLowerCase());
  const looksHeader = header.some(h=>['nom','prénom','prenom','téléphone','telephone','tel','email','e-mail','mail','present','présent','presence','montant','paid','paiement','payment','amount','somme'].includes(h));
  const data = looksHeader ? rows.slice(1) : rows;
  const find = names => header.findIndex(h=>names.includes(h));
  const idx = {
    nom:     find(['nom','name','last','lastname','surname']),
    prenom:  find(['prénom','prenom','first','firstname','given']),
    tel:     find(['téléphone','telephone','tel','phone','mobile']),
    mail:    find(['email','e-mail','mail']),
    present: find(['présent','present','presence']),
    montant: find(['montant','paid','paiement','payment','amount','somme'])
  };
  const get = (r,i,def)=> (i!=null && i>=0 ? r[i] : (r[def]??''));
  const normPresent = v => ['1','true','oui','o','y','yes','present','présent','x'].includes(String(v||'').toLowerCase());
  const normNum = v => { let s=String(v??'').trim(); if(!s) return null; s=s.replace(/\s/g,'').replace(',', '.'); const n=Number(s); return isNaN(n)?null:n; };
  return data.map(r=>({
    nom:get(r,idx.nom,0), prenom:get(r,idx.prenom,1),
    tel:get(r,idx.tel,2), mail:get(r,idx.mail,3),
    present:normPresent(get(r,idx.present,4)),
    montant:normNum(get(r,idx.montant,5))
  }));
}

/* ===== Init ===== */
render();
</script>
</body>
</html>
